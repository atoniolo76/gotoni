# gotoni - Lambda.ai Automation CLI

gotoni is an Ansible-inspired Go CLI tool that automates Lambda.ai cloud infrastructure management. It provides a simple way to launch GPU instances, manage SSH keys, configure filesystems, and execute deployment playbooks.

## Core Commands

### Instance Management

#### Launch Instance
Launch a new GPU instance with specified configuration:
```bash
gotoni launch --instance-type <type> --region <region> [--name <name>] [--filesystem <filesystem-name>]
```
- `--instance-type`: GPU instance type (e.g., gpu_1x_a100_sxm4, gpu_1x_h100_sxm5)
- `--region`: Region for deployment (e.g., us-east-1, us-west-2)
- `--name`: Optional instance name
- `--filesystem`: Optional filesystem to mount

#### Snipe Instance
Poll for instance availability and automatically launch when capacity becomes available:
```bash
gotoni snipe --instance-type <type> [--interval <duration>] [--timeout <duration>]
```
- `--interval`: Polling interval (default: 30s)
- `--timeout`: Maximum wait time (default: 1h)

#### List Instances
List running instances or available instance types:
```bash
gotoni list [--running]
```
- `--running`: Show only running instances

#### Delete Instance
Terminate instances:
```bash
gotoni delete <instance-id>
```

#### Connect to Instance
SSH into a running instance:
```bash
gotoni connect <instance-ip>
```

#### Run Command
Execute a command on a remote instance:
```bash
gotoni run [instance-id] <command>
```

### Task Management

#### Add Task
Interactively add a new task to the configuration:
```bash
gotoni add-task
```

#### Setup Tasks
Run setup tasks/playbooks on an instance:
```bash
gotoni setup [instance-id]
```

#### Start Services
Start service tasks (background processes managed by systemd):
```bash
gotoni start [instance-id]
```

#### Check Status
Check status of running services:
```bash
gotoni status [instance-id]
```

#### View Logs
View logs from running services:
```bash
gotoni logs [instance-id] [service-name]
```

### SSH Key Management

#### List SSH Keys
List SSH keys managed by gotoni:
```bash
gotoni ssh-keys list
```

#### Get SSH Key
Get SSH key associated with an instance:
```bash
gotoni ssh-keys get <instance-id> [--link]
```
- `--link`: Create symlink to key in current directory

#### Add SSH Key
Add an existing SSH key file to gotoni configuration:
```bash
gotoni ssh-keys add <key-path> [--name <name>]
```
- `--name`: Optional custom name for the key

#### Delete SSH Key
Remove an SSH key:
```bash
gotoni ssh-keys delete <key-id>
```

### Filesystem Management

#### List Filesystems
List available filesystems:
```bash
gotoni filesystems list
```

#### Delete Filesystem
Remove a filesystem:
```bash
gotoni filesystems delete <filesystem-id>
```

### Monitoring

#### GPU Monitoring
Track GPU memory usage and log to CSV:
```bash
gotoni gpu [instance-id] --log <file.csv>
```

### Utility Commands

#### Update
Update gotoni to the latest version:
```bash
gotoni update
```

## Configuration

Configuration is stored in `~/.gotoni/config.yaml`:

```yaml
instances:
  instance-123: lambda-key-1234567890

ssh_keys:
  lambda-key-1234567890: ssh/lambda-key-1234567890.pem

filesystems:
  my-data:
    id: fs-123
    region: us-east-1

tasks:
  - name: "Install dependencies"
    type: "command"
    command: "sudo apt-get update"

  - name: "Start server"
    type: "service"
    command: "python app.py"
    depends_on:
      - Install dependencies
```

## Task Types

### Command Tasks
Execute shell commands on instances:
- `type: "command"` - One-time command execution
- `command`: Shell command to run
- `background: true` - Run in background (optional)
- `working_dir`: Working directory (optional)
- `env`: Environment variables (optional)
- `depends_on`: Task dependencies (optional)

### Service Tasks
Long-running processes managed by systemd:
- `type: "service"` - Background service
- `command`: Service command
- `restart`: Restart policy (always, on-failure, on-success, no)
- `restart_sec`: Restart delay in seconds
- `working_dir`: Working directory
- `env`: Environment variables
- `depends_on`: Task dependencies

## Go API Usage

### Core Client Functions

#### Instance Management
```go
import "github.com/atoniolo76/gotoni/pkg/client"

// Launch instance
instances, err := client.LaunchInstance(httpClient, apiToken, instanceType, region, quantity, name, sshKeyName, filesystemName)

// Launch and wait for ready
instances, err := client.LaunchAndWait(httpClient, apiToken, instanceType, region, quantity, name, sshKeyName, timeout, filesystemName)

// List running instances
instances, err := client.ListRunningInstances(httpClient, apiToken)

// Terminate instances
response, err := client.TerminateInstance(httpClient, apiToken, instanceIDs)
```

#### SSH Key Management
```go
// Create new SSH key
keyName, keyFile, err := client.CreateSSHKeyForProject(httpClient, apiToken)

// List SSH keys
keys, err := client.ListSSHKeys(httpClient, apiToken)

// Add existing key
keyName, targetPath, err := client.AddExistingSSHKey(keyPath, customName)

// Delete SSH key
err := client.DeleteSSHKey(httpClient, apiToken, sshKeyID)
```

#### Filesystem Management
```go
// Create filesystem
fs, err := client.CreateFilesystem(httpClient, apiToken, name, region)

// List filesystems
filesystems, err := client.ListFilesystems(httpClient, apiToken)

// Delete filesystem
err := client.DeleteFilesystem(httpClient, apiToken, filesystemID)
```

#### Task Execution
```go
// Execute single task
err := client.ExecuteTask(manager, instanceIP, task, completedTasks)

// Execute all tasks
err := client.ExecuteTasks(manager, instanceIP, tasks)

// Filter tasks by type
serviceTasks := client.FilterTasksByType(tasks, "service")
```

#### Firewall Management
```go
// Get firewall rules
ruleset, err := client.GetGlobalFirewallRules(httpClient, apiToken)

// Update firewall rules
updatedRuleset, err := client.UpdateGlobalFirewallRules(httpClient, apiToken, rules)

// Ensure port is open
err := client.EnsurePortOpen(httpClient, apiToken, port, protocol, description)
```

### Configuration Management
```go
// Load configuration
config, err := client.LoadConfig()

// Save configuration
err := client.SaveConfig(config)

// Get SSH key for instance
sshKeyFile, err := client.GetSSHKeyForInstance(instanceID)

// Remove instance from config
err := client.RemoveInstanceFromConfig(instanceID)
```

### Instance Types & GPU Requirements

Common GPU instance types:
- `gpu_1x_gh200`: GH200 (96 GB)
- `gpu_1x_h100_sxm5`: H100 (80 GB SXM5)
- `gpu_1x_h100_pcie`: H100 (80 GB PCIe)
- `gpu_1x_a10_pcie`: A10 (24 GB PCIe)
- `gpu_1x_a100_sxm4`: A100 (40 GB SXM4)

CUDA version requirements:
- H100 series: CUDA 12.0+
- A100 series: CUDA 11.0+
- RTX 6000/5000/4000 Ada: CUDA 11.8+
- RTX 6000: CUDA 10.0+

## Setup Requirements

1. Install gotoni:
```bash
curl -fsSL https://raw.githubusercontent.com/atoniolo76/gotoni/main/install.sh | bash
```

2. Set API token:
```bash
export LAMBDA_API_KEY=your_token_here
```

3. Configure SSH keys and tasks as needed

## Error Handling

All functions return descriptive error messages. Common error patterns:
- Network timeouts: Check internet connection and API token
- Instance unavailable: Use `snipe` command to wait for capacity
- SSH connection failures: Verify key permissions (0600) and instance state
- Dependency errors: Check task dependencies in configuration

## Best Practices

1. Use descriptive names for instances and tasks
2. Set appropriate restart policies for services
3. Use `depends_on` to ensure proper task ordering
4. Monitor GPU usage with the `gpu` command
5. Regularly update SSH keys and rotate access
6. Use filesystems for persistent data storage
